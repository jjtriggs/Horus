<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>James Triggs â€” CTO Development</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.github.com https://api.anthropic.com; img-src 'self' data: https:; frame-ancestors 'none'">
<style>
:root{--bg:#0a0f1e;--surface:#111827;--surface2:#1a2236;--border:#1f2d44;--text:#e2e8f0;--muted:#94a3b8;--accent:#6366f1;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--radius:8px}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:14px;line-height:1.6;padding-bottom:60px}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:18px 32px;display:flex;align-items:center;justify-content:space-between}
h1{font-size:20px;font-weight:800}
.sub{font-size:12px;color:var(--muted);margin-top:2px}
.header-right{display:flex;align-items:center;gap:12px}
.sync-badge{font-size:11px;padding:3px 10px;border-radius:20px;background:rgba(34,197,94,.15);color:var(--green);opacity:0;transition:opacity .5s}
.sync-badge.show{opacity:1}
.sync-badge.error{background:rgba(239,68,68,.15);color:var(--red);opacity:1}
main{max-width:960px;margin:0 auto;padding:32px 24px}

/* Connect screen */
#connect-screen{max-width:480px;margin:80px auto;text-align:center}
#connect-screen .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:36px}
#connect-screen h2{font-size:20px;font-weight:700;margin-bottom:8px}
#connect-screen p{color:var(--muted);font-size:13px;margin-bottom:24px;line-height:1.6}
.input-wrap{position:relative;margin-bottom:12px}
input[type=password],input[type=text]{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:13px;outline:none;font-family:monospace}
input:focus{border-color:var(--accent)}
.connect-error{color:var(--red);font-size:12px;margin-top:8px;display:none}
.connect-steps{text-align:left;font-size:12px;color:var(--muted);margin-bottom:20px;padding:12px 16px;background:var(--surface2);border-radius:var(--radius);line-height:2}

/* Scores */
.score-banner{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px}
.score-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center}
.score-card.combined{border-color:var(--accent)}
.score-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.score-val{font-size:30px;font-weight:800;margin:5px 0 2px}
.score-max{font-size:11px;color:var(--muted)}
.progress-label{font-size:12px;color:var(--muted);font-weight:600;margin-top:6px}

/* Gates */
.gate-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:28px}
.section-title{font-size:14px;font-weight:700;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.gate-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.gate-label{font-size:12px;width:210px;flex-shrink:0}
.gate-bar-bg{flex:1;background:var(--surface2);border-radius:20px;height:7px;overflow:hidden}
.gate-bar{height:100%;border-radius:20px;transition:width .5s}
.gate-target{font-size:11px;font-weight:700;width:80px;text-align:right;flex-shrink:0}
.gate-controls{margin-top:14px;display:flex;flex-wrap:wrap;gap:14px}
.gate-control{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:12px;color:var(--text)}
.gate-control input[type=number]{width:44px;padding:3px 7px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px;text-align:center}

/* Tabs */
.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:24px}
.tab{padding:10px 20px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted);cursor:pointer;font-size:13px;font-weight:500;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.pane{display:none}.pane.active{display:block}

/* Competencies */
.comp-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.comp-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.comp-title{font-size:15px;font-weight:700}
.comp-id{font-size:11px;color:var(--muted);margin-bottom:2px}
.chip{display:inline-block;padding:3px 12px;border-radius:20px;font-size:12px;font-weight:700}
.chip-g{background:rgba(34,197,94,.15);color:var(--green)}
.chip-a{background:rgba(245,158,11,.15);color:var(--amber)}
.chip-r{background:rgba(239,68,68,.15);color:var(--red)}
.comp-desc{font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.55}
.score-btns{display:flex;gap:7px;margin-bottom:8px}
.sbtn{width:36px;height:36px;border-radius:50%;border:2px solid var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.sbtn:hover{border-color:var(--accent);color:var(--text)}
.sbtn.active{border-color:var(--accent);background:var(--accent);color:#fff}
.level-desc{font-size:12px;color:var(--amber);min-height:18px;margin-bottom:10px}
label{font-size:11px;color:var(--muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em}
textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;padding:9px 12px;resize:vertical;outline:none;font-family:inherit;line-height:1.5}
textarea:focus{border-color:var(--accent)}

/* Journal */
.journal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px}
.journal-meta{font-size:11px;color:var(--muted);display:flex;justify-content:space-between;margin-bottom:8px}

/* Actions */
.action-group{margin-bottom:20px}
.action-group-title{font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px}
.action-row{display:flex;align-items:flex-start;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px}
.action-row:last-child{border-bottom:none}

/* Buttons */
.btn{padding:8px 16px;border-radius:var(--radius);border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-size:13px;transition:background .15s}
.btn:hover{background:var(--surface2)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:#4f46e5}
.btn-sm{padding:4px 10px;font-size:11px}
.btn-danger{border-color:var(--red);color:var(--red)}
.btn-danger:hover{background:rgba(239,68,68,.1)}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.mt{margin-top:16px}
.info-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;font-size:12px;color:var(--muted);line-height:1.6}
.info-box code{background:var(--bg);padding:2px 6px;border-radius:4px;font-family:monospace;color:var(--text)}
@media(max-width:600px){.score-banner{grid-template-columns:1fr 1fr}.two-col{grid-template-columns:1fr}}

/* Team Tracking */
.team-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.win-btn{padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:12px;font-weight:600;transition:all .15s}
.win-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.win-btn:hover:not(.active){color:var(--text);border-color:var(--muted)}
.team-summary-banner{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:24px}
.tsb{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;text-align:center}
.tsb-val{font-size:22px;font-weight:800;margin:4px 0 2px}
.tsb-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.team-section{margin-bottom:28px}
.team-section-title{font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.member-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.member-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.member-name{font-size:13px;font-weight:700;margin-bottom:2px}
.member-handle{font-size:10px;color:var(--muted);font-family:monospace;margin-bottom:10px}
.stat-grid4{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:10px}
.sbox{background:var(--surface2);border-radius:5px;padding:6px 8px;text-align:center}
.sbox-v{font-size:17px;font-weight:800;line-height:1}
.sbox-l{font-size:9px;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.04em}
.cc-tag{display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px}
.cc-yes{background:rgba(99,102,241,.2);color:var(--accent)}
.cc-no{background:rgba(148,163,184,.1);color:var(--muted)}
.team-empty{text-align:center;padding:48px;color:var(--muted);font-size:13px}
.team-stale{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:var(--radius);padding:10px 14px;font-size:12px;color:var(--amber);margin-bottom:16px}
.team-fetched{font-size:11px;color:var(--muted)}
@media(max-width:600px){.team-summary-banner{grid-template-columns:repeat(3,1fr)}.member-grid{grid-template-columns:1fr 1fr}}
/* Charts */
.chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;overflow-x:auto;margin-bottom:24px}
.chart-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px}
.chart-legend{display:flex;gap:16px;margin-top:8px;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted)}
.legend-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
/* Member card clickable */
.member-card{cursor:pointer;transition:border-color .15s}
.member-card:hover{border-color:#6366f1}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:flex-start;justify-content:center;padding:48px 20px;overflow-y:auto}
.modal-overlay.hidden{display:none}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:100%;max-width:620px;padding:28px;position:relative;flex-shrink:0}
.modal-close{position:absolute;top:14px;right:14px;background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px 8px;border-radius:var(--radius);line-height:1}
.modal-close:hover{background:var(--surface2);color:var(--text)}
.modal-name{font-size:20px;font-weight:800;margin-bottom:4px}
.modal-meta{font-size:12px;color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.modal-stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px}
.modal-stat{background:var(--surface2);border-radius:var(--radius);padding:10px;text-align:center}
.modal-stat-v{font-size:22px;font-weight:800;line-height:1}
.modal-stat-l{font-size:9px;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:.04em}
.modal-loading{font-size:12px;color:var(--muted);padding:28px;text-align:center}
/* Score badge */
.score-badge{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:12px;font-weight:800}
/* Leaderboard row */
.lb-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.lb-row:last-child{border-bottom:none}
.lb-bar-bg{flex:1;background:var(--surface2);border-radius:20px;height:5px;overflow:hidden}
.lb-bar{height:100%;border-radius:20px}
/* Score pillar bars in modal */
.pillar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px}
.pillar-label{width:120px;flex-shrink:0;color:var(--muted)}
.pillar-bar-bg{flex:1;background:var(--surface2);border-radius:20px;height:8px;overflow:hidden}
.pillar-bar{height:100%;border-radius:20px;transition:width .4s}
.pillar-val{width:32px;text-align:right;font-weight:700;font-size:12px;flex-shrink:0}
/* AI usage bar */
.ai-usage-strip{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;gap:16px;font-size:12px;flex-wrap:wrap}
</style>
</head>
<body>

<!-- Connect screen (shown when not authenticated) -->
<div id="connect-screen" style="display:none">
  <div class="card">
    <div style="font-size:32px;margin-bottom:12px">ðŸ”’</div>
    <h2>CTO Development Tracker</h2>
    <p>Personal development journal for James Triggs.<br/>
    Connect with your GitHub token to load your data from a private Gist.</p>
    <div class="connect-steps">
      <strong style="color:var(--text)">Your data is stored in a private GitHub Gist</strong><br/>
      Only you can read or write it. The token is saved in this browser only.
    </div>
    <input type="password" id="connect-token" placeholder="Paste your GitHub PAT (github_pat_...)" autocomplete="off"/>
    <div id="connect-error" class="connect-error"></div>
    <div class="mt">
      <button class="btn btn-primary" style="width:100%" id="btn-connect">Connect</button>
    </div>
    <p style="margin-top:14px;font-size:11px;color:var(--muted)">
      New device? Enter the same token â€” your Gist will be found automatically.
    </p>
  </div>
</div>

<!-- Main app (shown when authenticated) -->
<div id="app-screen" style="display:none">
<header>
  <div>
    <h1>CTO Development Tracker</h1>
    <div class="sub">James Triggs &middot; Data stored in private GitHub Gist &middot; <span id="last-saved-label">â€”</span></div>
  </div>
  <div class="header-right">
    <span id="sync-badge" class="sync-badge">Saved to Gist</span>
    <button class="btn btn-sm" id="btn-save-now">Save now</button>
    <button class="btn btn-sm btn-danger" id="btn-disconnect">Disconnect</button>
  </div>
</header>

<main>

<div class="score-banner">
  <div class="score-card">
    <div class="score-label">D1 Engineering</div>
    <div class="score-val" id="b-d1">30.0</div>
    <div class="score-max">/ 40</div>
  </div>
  <div class="score-card">
    <div class="score-label">D2 AI Maturity</div>
    <div class="score-val" id="b-d2">13.3</div>
    <div class="score-max">/ 20</div>
  </div>
  <div class="score-card">
    <div class="score-label">D3 Competencies</div>
    <div class="score-val" id="b-d3">â€”</div>
    <div class="score-max">/ 40</div>
  </div>
  <div class="score-card combined">
    <div class="score-label">Combined</div>
    <div class="score-val" id="b-combined">â€”</div>
    <div class="score-max">/ 100</div>
    <div class="progress-label" id="b-label">â€”</div>
  </div>
</div>

<div class="gate-card">
  <div class="section-title">CTO Promotion Gate 1 â€” Individual Readiness</div>
  <div id="gates-container"></div>
  <div class="gate-controls" id="gate-controls"></div>
</div>

<div class="tabs">
  <button class="tab active" data-pane="competencies">Big WHO Scorecard</button>
  <button class="tab" data-pane="journey">Development Journal</button>
  <button class="tab" data-pane="actions">Next Actions</button>
  <button class="tab" data-pane="team">Team Tracking</button>
  <button class="tab" data-pane="settings">Settings</button>
</div>

<div class="pane active" id="pane-competencies">
  <div id="competencies-container"></div>
</div>

<div class="pane" id="pane-journey">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <p style="color:var(--muted);font-size:13px">Quarterly reflections. Add an entry after each scorecard session with David.</p>
    <button class="btn btn-primary btn-sm" id="btn-add-journal">+ New Entry</button>
  </div>
  <div id="journal-container"></div>
</div>

<div class="pane" id="pane-actions">
  <div id="actions-container"></div>
</div>

<div class="pane" id="pane-team">
  <div id="team-stale-msg" class="team-stale" style="display:none">Data is more than 24 hours old â€” click Refresh to get the latest stats.</div>
  <div class="team-toolbar">
    <button class="win-btn active" data-days="30">30 days</button>
    <button class="win-btn" data-days="60">60 days</button>
    <button class="win-btn" data-days="90">90 days</button>
    <button class="btn btn-sm btn-primary" id="btn-team-refresh" style="margin-left:auto">Refresh</button>
    <span id="team-fetched-at" class="team-fetched"></span>
  </div>
  <div class="team-summary-banner" id="team-summary-banner"></div>
  <div id="team-ai-usage"></div>
  <div id="team-leaderboard"></div>
  <div id="team-org-trend"></div>
  <div id="team-sections"></div>
</div>

<div class="pane" id="pane-settings">
  <div class="info-box">
    <strong style="color:var(--text)">Your data Gist ID:</strong><br/>
    <code id="settings-gist-id">â€”</code><br/><br/>
    To set up on another device, enter the same GitHub token â€” your Gist will be found automatically by name.
    <br/><br/>
    <strong style="color:var(--text)">D1 and D2 scores</strong> (pulled from the engineering dashboard â€” update when the scorecard changes):<br/>
    <div style="display:flex;gap:12px;margin-top:10px">
      <div>
        <label>D1 weighted score</label>
        <input type="number" id="settings-d1" step="0.1" min="0" max="40" style="width:80px;background:var(--surface);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:5px 8px;font-size:13px"/>
      </div>
      <div>
        <label>D2 weighted score</label>
        <input type="number" id="settings-d2" step="0.1" min="0" max="20" style="width:80px;background:var(--surface);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:5px 8px;font-size:13px"/>
      </div>
    </div>
    <button class="btn btn-sm mt" id="btn-save-d1d2">Update scores</button>
    <br/><br/>
    <strong style="color:var(--text)">Anthropic Admin API key</strong> (optional â€” for live Claude Code adoption in Team Tracking):<br/>
    <span style="font-size:11px;color:var(--muted)">Stored in this browser only, never in your Gist. Get from <code>/senseon/dashboard/anthropic-admin-key</code> in AWS Secrets Manager.</span>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input type="password" id="settings-anthropic-key" placeholder="sk-ant-admin01-â€¦" autocomplete="off"
        style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:5px 8px;font-size:13px;font-family:monospace"/>
      <button class="btn btn-sm" id="btn-save-anthropic-key">Save</button>
    </div>
    <span id="anthropic-key-status" style="font-size:11px;color:var(--muted)"></span>
  </div>
</div>

<!-- Member modal -->
<div id="member-modal-overlay" class="modal-overlay hidden" onclick="if(event.target===this)closeMemberModal()">
  <div class="modal-box">
    <button class="modal-close" onclick="closeMemberModal()">âœ•</button>
    <div id="modal-body"></div>
  </div>
</div>
</main>
</div>

<script>
// â”€â”€ Competency definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COMPS = [
  {id:"C1",title:"Supporting Strategic Tech Vision",
   vp:"Internal engineering roadmap, execution focus.",
   cto:"Board-ready tech strategy supporting David's founder vision. You articulate why technical choices create competitive moat and present confidently to investors.",
   levels:["Haven't done this yet","Have an internal roadmap, not board-ready","Can articulate the tech strategy, not yet investor-ready","Contribute meaningfully to board narrative alongside David","Own the technology narrative independently"],
   actions:["Co-present engineering metrics at the July board meeting","Write a one-page technology narrative for Q3 board pack","Shadow David in 2+ customer tech-strategy sessions this quarter"]},
  {id:"C2",title:"Engineering Excellence at Scale",
   vp:"Manage the teams, keep things running day-to-day.",
   cto:"The org operates autonomously. Your week of absence produces zero degradation. Team leads own DORA metrics, incidents resolve without escalation.",
   levels:["Org entirely dependent on me for decisions","Critical decisions still go through me","Some autonomy but I'm still a bottleneck on much","Team leads largely autonomous; I remove blockers","Org runs autonomously; my focus is strategy, not operations"],
   actions:["Publish team lead ownership matrix â€” each lead owns their DORA metrics","Delegate incident command for P1s to leads, review retrospectively","Run a war game: plan a week away and see what would escalate"]},
  {id:"C3",title:"AI-Native Engineering Leadership",
   vp:"Ad hoc AI tool adoption â€” no org-wide standards.",
   cto:"Org-wide AI engineering standards defined and enforced. Eval frameworks in CI, PromptOps is standard practice, AI contribution to velocity measurable.",
   levels:["No AI standards, purely ad hoc","Aware of AI tooling, starting to shape direction","Some standards emerging, actively driving adoption","Standards set, evals in CI, measuring AI contribution to velocity","AI-native culture: AI is default, not exception"],
   actions:["Define and publish PromptOps standards with the pilot team (Q3)","Add LLM eval framework to CI for at least one AI-assisted feature","Produce a monthly AI adoption report for David from dashboard data"]},
  {id:"C4",title:"Cross-Functional Influence",
   vp:"Primarily engineering silo. Other functions come to you with requests.",
   cto:"In revenue conversations, customer tech sessions, and investor narrative discussions. You translate engineering output into business value language fluently.",
   levels:["Engineering silo â€” no external conversations","Starting to engage with other functions reactively","Regular cross-functional input, still reactive","Proactively shaping product/sales/investor narrative","Trusted voice in all business decisions, not just engineering"],
   actions:["Support David in 3 customer tech-strategy meetings this year","Present engineering health dashboard to the full leadership team","Write one external piece (talk, article or podcast) on technical strategy"]},
  {id:"C5",title:"Talent & Culture Builder",
   vp:"Hire engineers when there are open reqs.",
   cto:"Proactively identify world-class talent before you need it. Build a culture that is itself a hiring advantage.",
   levels:["Reactive hiring only, no talent pipeline","Beginning to build relationships with potential hires","Consistent culture investment, some pipeline building","Culture is a differentiator, talent pipeline active","Culture and talent are strategic moats; external recognition"],
   actions:["Identify 3 potential future hires and start a relationship now","Document 'what SenseOn engineering culture means' â€” publish internally","Launch one engineer-facing initiative that builds external reputation"]},
  {id:"C6",title:"Operational Rigor",
   vp:"Reactive â€” firefighting incidents, short-horizon planning.",
   cto:"Board-ready engineering health dashboard (you're building this), proactive capacity planning 2+ quarters out, engineering org is predictable to the business.",
   levels:["Purely reactive, no dashboards or forecasting","Some metrics tracked, still mostly reactive","DORA dashboard live, starting proactive planning","Predictable engineering health, 1-2 quarter horizon","Board-level operational visibility, 2+ quarter forecast horizon"],
   actions:["Present engineering health dashboard as a standing board item (Q3)","Produce Q3 capacity plan and share with David before the quarter","Define SLA for engineering predictability â€” hit it 2 consecutive quarters"]},
];

const GATE_ITEMS = [
  {id:"board",  label:"Board co-presentation delivered", target:"â‰¥1", type:"bool"},
  {id:"customer",label:"Customer tech sessions", target:"â‰¥3", type:"count", threshold:3},
  {id:"dashboard",label:"Eng health dashboard live + weekly review", target:"Live", type:"bool"},
];

// â”€â”€ GitHub Gist storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GIST_FILENAME = "cto_tracker_data.json";
const GIST_DESC     = "CTO Development Tracker â€” private data";
const LS_TOKEN      = "cto_gh_token";
const LS_GIST_ID    = "cto_gist_id";

let _token  = localStorage.getItem(LS_TOKEN)  || "";
let _gistId = localStorage.getItem(LS_GIST_ID) || "";
let _gistSha = "";          // ETag/version â€” not needed for Gist API
let _saveTimer = null;

function ghHeaders() {
  return {"Authorization": `Bearer ${_token}`, "Accept": "application/vnd.github+json", "Content-Type": "application/json"};
}

async function findOrCreateGist() {
  // Search user's gists for one with our description
  let page = 1;
  while (true) {
    const r = await fetch(`https://api.github.com/gists?per_page=100&page=${page}`, {headers: ghHeaders()});
    if (!r.ok) throw new Error(`Gist list failed: ${r.status}`);
    const gists = await r.json();
    if (!gists.length) break;
    const found = gists.find(g => g.description === GIST_DESC);
    if (found) { _gistId = found.id; localStorage.setItem(LS_GIST_ID, _gistId); return _gistId; }
    if (gists.length < 100) break;
    page++;
  }
  // Create new private Gist
  const r2 = await fetch("https://api.github.com/gists", {
    method: "POST", headers: ghHeaders(),
    body: JSON.stringify({description: GIST_DESC, public: false, files: {[GIST_FILENAME]: {content: JSON.stringify(defaultState(), null, 2)}}}),
  });
  if (!r2.ok) throw new Error(`Gist create failed: ${r2.status}`);
  const gist = await r2.json();
  _gistId = gist.id; localStorage.setItem(LS_GIST_ID, _gistId);
  return _gistId;
}

async function loadFromGist() {
  if (!_gistId) await findOrCreateGist();
  const r = await fetch(`https://api.github.com/gists/${_gistId}`, {headers: ghHeaders()});
  if (!r.ok) throw new Error(`Gist read failed: ${r.status}`);
  const gist = await r.json();
  const raw  = gist.files[GIST_FILENAME]?.content;
  return raw ? JSON.parse(raw) : defaultState();
}

async function saveToGist(state) {
  if (!_gistId) return;
  const r = await fetch(`https://api.github.com/gists/${_gistId}`, {
    method: "PATCH", headers: ghHeaders(),
    body: JSON.stringify({files: {[GIST_FILENAME]: {content: JSON.stringify(state, null, 2)}}}),
  });
  if (!r.ok) throw new Error(`Gist write failed: ${r.status}`);
  return r.json();
}

function scheduleSave() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async () => {
    try {
      await saveToGist(STATE);
      showSync("Saved to Gist", false);
      STATE.last_saved = new Date().toISOString();
      document.getElementById("last-saved-label").textContent = `Saved ${new Date().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}`;
    } catch(e) {
      showSync("Save failed: " + e.message, true);
    }
  }, 2000);
}

function showSync(msg, isError) {
  const el = document.getElementById("sync-badge");
  el.textContent = msg;
  el.className = "sync-badge show" + (isError ? " error" : "");
  if (!isError) setTimeout(() => el.classList.remove("show"), 3000);
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function defaultState() {
  return {scores:{C1:3,C2:3,C3:3,C4:3,C5:3,C6:3}, evidence:{}, journal:[], actions:{}, gates:{}, d1:30.0, d2:13.3, last_saved:null, team_cache:null};
}
let STATE = defaultState();

function compute() {
  const raw  = Object.values(STATE.scores).reduce((a,b)=>a+b,0);
  const d3   = +(raw/30*40).toFixed(1);
  const comb = +(STATE.d1 + STATE.d2 + d3).toFixed(1);
  const lbl  = comb>=84?"CTO-Ready":comb>=78?"Strong":comb>=62?"Progressing":comb>=50?"Developing":"Early";
  const minS = Math.min(...Object.values(STATE.scores));
  return {raw, d3, comb, lbl, minS};
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBanner() {
  const s = compute();
  document.getElementById("b-d1").textContent = STATE.d1.toFixed(1);
  document.getElementById("b-d2").textContent = STATE.d2.toFixed(1);
  document.getElementById("b-d3").textContent = s.d3.toFixed(1);
  document.getElementById("b-combined").textContent = s.comb.toFixed(1);
  document.getElementById("b-label").textContent = s.lbl;
}

function renderGates() {
  const s = compute();
  const passes = [
    s.raw >= 22,
    s.minS >= 3,
    !!STATE.gates.board,
    (parseInt(STATE.gates.customer)||0) >= 3,
    !!STATE.gates.dashboard,
  ];
  const labels  = ["D3 score â‰¥22/30", "No competency below 3", "Board co-presentation", "Customer tech sessions", "Eng health dashboard"];
  const targets = ["â‰¥22/30", "All â‰¥3", "â‰¥1 done", "â‰¥3", "Live"];
  const pcts    = [
    Math.min(100, Math.round(s.raw/22*100)),
    s.minS >= 3 ? 100 : Math.round(s.minS/3*100),
    passes[2]?100:0, Math.min(100,Math.round(((parseInt(STATE.gates.customer)||0)/3)*100)), passes[4]?100:0,
  ];
  document.getElementById("gates-container").innerHTML = labels.map((lbl,i) => {
    const col = passes[i]?"var(--green)":pcts[i]>50?"var(--amber)":"var(--red)";
    return `<div class="gate-row">
      <span class="gate-label">${lbl}</span>
      <div class="gate-bar-bg"><div class="gate-bar" style="width:${pcts[i]}%;background:${col}"></div></div>
      <span class="gate-target" style="color:${col}">${targets[i]}</span>
    </div>`;
  }).join("");
  document.getElementById("gate-controls").innerHTML = `
    <label class="gate-control"><input type="checkbox" ${STATE.gates.board?"checked":""} id="g-board"/> Board co-presentation delivered</label>
    <label class="gate-control"><input type="checkbox" ${STATE.gates.dashboard?"checked":""} id="g-dashboard"/> Eng health dashboard live + reviewed weekly</label>
    <label class="gate-control">Customer tech sessions: <input type="number" id="g-customer" min="0" max="20" value="${STATE.gates.customer||0}"/> / 3</label>`;
  document.getElementById("g-board").onchange    = e => { STATE.gates.board = e.target.checked; scheduleSave(); renderGates(); };
  document.getElementById("g-dashboard").onchange = e => { STATE.gates.dashboard = e.target.checked; scheduleSave(); renderGates(); };
  document.getElementById("g-customer").onchange  = e => { STATE.gates.customer = parseInt(e.target.value)||0; scheduleSave(); renderGates(); };
}

function renderCompetencies() {
  document.getElementById("competencies-container").innerHTML = COMPS.map(c => {
    const sc  = STATE.scores[c.id]||0;
    const ev  = STATE.evidence[c.id]||"";
    const ch  = sc>=4?"chip-g":sc>=3?"chip-a":"chip-r";
    const btns= [1,2,3,4,5].map(n=>`<button class="sbtn${sc===n?" active":""}" data-comp="${c.id}" data-n="${n}">${n}</button>`).join("");
    return `<div class="comp-card" id="cc-${c.id}">
      <div class="comp-hdr">
        <div><div class="comp-id">${c.id}</div><div class="comp-title">${c.title}</div></div>
        <span class="chip ${ch}" id="ch-${c.id}">${sc||"â€”"}/5</span>
      </div>
      <div class="comp-desc"><strong style="color:var(--text)">VP Eng now:</strong> ${c.vp}<br/><strong style="color:var(--text)">CTO target:</strong> ${c.cto}</div>
      <div class="score-btns">${btns}</div>
      <div class="level-desc" id="ld-${c.id}">${sc?c.levels[sc-1]:""}</div>
      <label>Evidence &amp; examples â€” what demonstrates this score?</label>
      <textarea rows="3" data-ev="${c.id}" placeholder="Concrete examples from the last 90 days...">${ev}</textarea>
    </div>`;
  }).join("");
}

function renderJournal() {
  const c = document.getElementById("journal-container");
  if (!STATE.journal.length) { c.innerHTML = `<p style="color:var(--muted);text-align:center;padding:32px">No entries yet. Click New Entry after each scorecard session.</p>`; return; }
  c.innerHTML = STATE.journal.slice().reverse().map((e,ri) => {
    const idx = STATE.journal.length-1-ri;
    return `<div class="journal-card">
      <div class="journal-meta">
        <span>${e.date} &middot; D3: ${e.d3raw}/30 &middot; Combined: ${e.combined}/100</span>
        <button class="btn btn-sm btn-danger" data-del="${idx}">Delete</button>
      </div>
      <textarea rows="6" data-jidx="${idx}" placeholder="Reflection: what went well, what to improve, what David said...">${e.text||""}</textarea>
    </div>`;
  }).join("");
}

function renderActions() {
  document.getElementById("actions-container").innerHTML = COMPS.map(c => {
    const done = STATE.actions[c.id]||[];
    return `<div class="action-group">
      <div class="action-group-title">${c.id}: ${c.title}</div>
      ${c.actions.map((a,i)=>{
        const key=`${c.id}_${i}`;const chk=done.includes(key);
        return `<div class="action-row">
          <input type="checkbox" ${chk?"checked":""} data-act="${key}" data-cid="${c.id}"/>
          <span style="text-decoration:${chk?"line-through":"none"};color:${chk?"var(--muted)":"var(--text)"}">${a}</span>
        </div>`;
      }).join("")}
    </div>`;
  }).join("");
}

function renderSettings() {
  document.getElementById("settings-gist-id").textContent = _gistId || "Not connected";
  const d1 = document.getElementById("settings-d1");
  const d2 = document.getElementById("settings-d2");
  if (d1) d1.value = STATE.d1;
  if (d2) d2.value = STATE.d2;
}

function renderAll() { renderBanner(); renderGates(); renderCompetencies(); renderJournal(); renderActions(); renderSettings(); renderSettingsAnthropicKey(); }

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("click", e => {
  // Score buttons
  const sbtn = e.target.closest(".sbtn[data-comp]");
  if (sbtn) {
    const cid = sbtn.dataset.comp, n = parseInt(sbtn.dataset.n), c = COMPS.find(x=>x.id===cid);
    STATE.scores[cid] = n;
    // Update card inline
    document.querySelectorAll(`.sbtn[data-comp="${cid}"]`).forEach(b => b.classList.toggle("active", parseInt(b.dataset.n)===n));
    document.getElementById(`ld-${cid}`).textContent = c.levels[n-1];
    const ch = n>=4?"chip-g":n>=3?"chip-a":"chip-r";
    document.getElementById(`ch-${cid}`).className = `chip ${ch}`;
    document.getElementById(`ch-${cid}`).textContent = `${n}/5`;
    renderBanner(); renderGates();
    scheduleSave(); return;
  }
  // Delete journal
  const del = e.target.closest("[data-del]");
  if (del && confirm("Delete this entry?")) {
    STATE.journal.splice(parseInt(del.dataset.del),1);
    renderJournal(); scheduleSave(); return;
  }
  // Action checkbox
  const act = e.target.closest("[data-act]");
  if (act && act.tagName==="INPUT") {
    const key=act.dataset.act, cid=act.dataset.cid;
    if (!STATE.actions[cid]) STATE.actions[cid]=[];
    if (act.checked) { if(!STATE.actions[cid].includes(key)) STATE.actions[cid].push(key); }
    else STATE.actions[cid]=STATE.actions[cid].filter(k=>k!==key);
    renderActions(); scheduleSave(); return;
  }
});

document.addEventListener("change", e => {
  // Evidence textarea
  const ev = e.target.dataset.ev;
  if (ev) { STATE.evidence[ev] = e.target.value; scheduleSave(); return; }
  // Journal textarea
  const ji = e.target.dataset.jidx;
  if (ji !== undefined) { STATE.journal[parseInt(ji)].text = e.target.value; scheduleSave(); return; }
});

// â”€â”€ Boot & auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  if (_token) {
    try {
      // Verify token still valid
      const r = await fetch("https://api.github.com/user", {headers: ghHeaders()});
      if (!r.ok) throw new Error("Token invalid");
      const user = await r.json();
      if (user.login !== "jjtriggs") throw new Error(`Wrong account: ${user.login}`);
      // Load data
      STATE = await loadFromGist();
      showApp();
    } catch(e) {
      localStorage.removeItem(LS_TOKEN);
      localStorage.removeItem(LS_GIST_ID);
      _token=""; _gistId="";
      showConnect(e.message);
    }
  } else {
    showConnect();
  }
}

function showConnect(err) {
  document.getElementById("connect-screen").style.display="block";
  document.getElementById("app-screen").style.display="none";
  if (err) { document.getElementById("connect-error").textContent=err; document.getElementById("connect-error").style.display="block"; }
}

function showApp() {
  document.getElementById("connect-screen").style.display="none";
  document.getElementById("app-screen").style.display="block";
  renderAll();
  if (STATE.last_saved) {
    document.getElementById("last-saved-label").textContent = `Last saved ${new Date(STATE.last_saved).toLocaleString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})}`;
  }
  // Load pre-fetched team metrics from repo JSON (populated by fetch_data.py)
  loadStaticMetrics();
}

// Load team-metrics.json from the repo (written by fetch_data.py / after each browser refresh).
// Only uses it if the Gist doesn't already have fresher cached data.
async function loadStaticMetrics() {
  try {
    const r = await fetch("/data/team-metrics.json");
    if (!r.ok) return;
    const data = await r.json();
    if (!data.fetched_at) return;
    const fileAge  = Date.now() - new Date(data.fetched_at).getTime();
    const cacheAge = STATE.team_cache?.fetched_at
      ? Date.now() - new Date(STATE.team_cache.fetched_at).getTime()
      : Infinity;
    // Use file data if it's fresher than what's in the Gist
    if (fileAge < cacheAge) {
      STATE.team_cache = data;
      _teamWindow = data.window_days || 30;
      document.querySelectorAll(".win-btn[data-days]").forEach(b =>
        b.classList.toggle("active", parseInt(b.dataset.days) === _teamWindow));
      if (document.getElementById("pane-team")?.classList.contains("active")) renderTeam();
    }
  } catch(_) {}
}

// After a live browser refresh, persist the data back to the repo JSON via the local server.
async function saveMetricsToFile(cache) {
  try {
    await fetch("/api/save-metrics", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(cache),
    });
  } catch(_) {} // Silently ignore if server doesn't support it
}

document.getElementById("btn-connect").addEventListener("click", async () => {
  const token = document.getElementById("connect-token").value.trim();
  const errEl = document.getElementById("connect-error");
  const btn   = document.getElementById("btn-connect");
  if (!token) { errEl.textContent="Please paste your GitHub token."; errEl.style.display="block"; return; }
  btn.textContent="Connectingâ€¦"; btn.disabled=true;
  try {
    const r = await fetch("https://api.github.com/user", {headers: {"Authorization":`Bearer ${token}`,"Accept":"application/vnd.github+json"}});
    if (!r.ok) throw new Error(`GitHub API ${r.status} â€” check your token`);
    const user = await r.json();
    if (user.login !== "jjtriggs") throw new Error(`This token belongs to '${user.login}', not jjtriggs`);
    _token = token;
    localStorage.setItem(LS_TOKEN, token);
    STATE = await loadFromGist();
    showApp();
  } catch(e) {
    errEl.textContent = e.message; errEl.style.display="block";
  } finally { btn.textContent="Connect"; btn.disabled=false; }
});

document.getElementById("btn-disconnect").addEventListener("click", () => {
  if (!confirm("This clears your saved token from this browser. Your Gist data is unaffected.")) return;
  localStorage.removeItem(LS_TOKEN); localStorage.removeItem(LS_GIST_ID);
  _token=""; _gistId="";
  showConnect();
});

document.getElementById("btn-save-now").addEventListener("click", async () => {
  try { await saveToGist(STATE); showSync("Saved to Gist", false); }
  catch(e) { showSync("Save failed: "+e.message, true); }
});

document.getElementById("btn-add-journal").addEventListener("click", () => {
  const s = compute();
  STATE.journal.push({date: new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}), d3raw:s.raw, combined:s.comb, text:""});
  renderJournal(); scheduleSave();
  document.querySelector("[data-jidx='0']")?.focus();
});

document.querySelectorAll(".tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".pane").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(`pane-${btn.dataset.pane}`).classList.add("active");
    if (btn.dataset.pane==="settings") { renderSettings(); renderSettingsAnthropicKey(); }
    if (btn.dataset.pane==="team") renderTeam();
  });
});

document.getElementById("btn-team-refresh")?.addEventListener("click", () => refreshTeamData());

document.addEventListener("click", e => {
  const wb = e.target.closest(".win-btn[data-days]");
  if (wb) {
    _teamWindow = parseInt(wb.dataset.days);
    document.querySelectorAll(".win-btn[data-days]").forEach(b =>
      b.classList.toggle("active", parseInt(b.dataset.days) === _teamWindow));
    renderTeam();
  }
});

document.getElementById("btn-save-anthropic-key")?.addEventListener("click", () => {
  const val = document.getElementById("settings-anthropic-key").value.trim();
  _anthropicKey = val;
  if (val) localStorage.setItem(LS_ANTHROPIC_KEY, val);
  else localStorage.removeItem(LS_ANTHROPIC_KEY);
  renderSettingsAnthropicKey();
  showSync("Anthropic key saved", false);
});

document.getElementById("btn-save-d1d2")?.addEventListener("click", () => {
  STATE.d1 = parseFloat(document.getElementById("settings-d1").value) || 30.0;
  STATE.d2 = parseFloat(document.getElementById("settings-d2").value) || 13.3;
  renderBanner(); scheduleSave();
});

// â”€â”€ Team Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const TEAM_DATA = [
  {team:"Frontend", members:[
    {name:"Tom Tidswell",   github:"tomtidswell",       cc:true,  lead:true},
    {name:"Terry Hibbert",  github:"TerryHibbert",      cc:true,  lead:false},
    {name:"Chris Crouch",   github:"chrisdc",           cc:true,  lead:false},
  ]},
  {team:"Python", members:[
    {name:"Matt Brighty",    github:"MBrighty",          cc:true,  lead:true},
    {name:"Cameron Bamford", github:"CameronBamford",    cc:true,  lead:false},
    {name:"Hikmat Hasan",    github:"hh2110",            cc:true,  lead:false},
    {name:"Luke Moran",      github:"lukemoran-so",      cc:true,  lead:false},
  ]},
  {team:"Endpoint", members:[
    {name:"Andrea Marangoni",github:"AndreaSenseon",    cc:true,  lead:true},
    {name:"Ollie Perry",     github:"operry-senseon",   cc:true,  lead:false},
    {name:"Fabian Ceccato",  github:"fabianceccato",    cc:true,  lead:false},
  ]},
  {team:"DevOps", members:[
    {name:"Ethan Moore",       github:"EthanM-0",       cc:true,  lead:true},
    {name:"Tim Curtis",        github:"timjohncurtis",        cc:true,  lead:false},
    {name:"Mark JL",           github:"mark-jordanovic-lewis",           cc:true,  lead:false},
    {name:"Anthony Sikosa",    github:"asikosa-senseon",   cc:true,  lead:false},
    {name:"Thomas McGarrigan", github:"thomas-mcgarrigan", cc:true,  lead:false},
  ]},
];

const LS_ANTHROPIC_KEY = "cto_anthropic_key";
let _anthropicKey = localStorage.getItem(LS_ANTHROPIC_KEY) || "";
let _teamWindow = 30;

// When running locally via server.py, route Anthropic calls through the local proxy
// to avoid CORS. On any other host, fall back to direct (won't work, but fails gracefully).
const ANT_BASE = (location.hostname === "127.0.0.1" || location.hostname === "localhost")
  ? "/proxy/anthropic"
  : "https://api.anthropic.com";

function _teamSlug(handle) {
  return 'u_' + handle.toLowerCase().replace(/[^a-z0-9]/g, '_');
}

function _isoSince(days) {
  const d = new Date(Date.now() - days * 86400000);
  return d.toISOString().slice(0, 10);
}

// Generate weekly date buckets backwards from today.
function _getWeeks(days) {
  const numWeeks = Math.max(1, Math.round(days / 7));
  const weeks = [];
  const now = new Date();
  for (let i = numWeeks - 1; i >= 0; i--) {
    const endDt   = new Date(now.getTime() - i * 7 * 86400000);
    const startDt = new Date(endDt.getTime() - 6 * 86400000);
    const fmt = d => d.toISOString().slice(0, 10);
    const label = startDt.toLocaleString("en-GB", {day:"numeric", month:"short"});
    weeks.push({start: fmt(startDt), end: fmt(endDt), label});
  }
  return weeks;
}

// Pure SVG grouped bar chart â€” returns HTML string.
// series = [{key, label, color}] using hex colors.
function renderBarChart(weeks, series, width, height) {
  if (!weeks?.length) return '<p style="color:#94a3b8;font-size:12px;text-align:center;padding:20px">No data</p>';
  const padL=38, padR=12, padT=10, padB=28;
  const cW = width - padL - padR, cH = height - padT - padB;
  let maxVal = 1;
  weeks.forEach(w => series.forEach(s => { if ((w[s.key]||0) > maxVal) maxVal = w[s.key]; }));
  const nG = weeks.length, nS = series.length;
  const gW = cW / nG, bW = Math.max(2, Math.floor((gW - 2*(nS+1)) / nS));
  let grid="", ylbls="";
  for (let i=0; i<=4; i++) {
    const y = padT + cH - cH*i/4;
    const v = Math.round(maxVal*i/4);
    grid  += `<line x1="${padL}" y1="${y}" x2="${padL+cW}" y2="${y}" stroke="#1f2d44" stroke-width="1"/>`;
    ylbls += `<text x="${padL-4}" y="${y+4}" text-anchor="end" font-size="9" fill="#94a3b8">${v}</text>`;
  }
  let bars="", xlbls="";
  weeks.forEach((w, gi) => {
    const gx = padL + gi*gW;
    series.forEach((s, si) => {
      const val = w[s.key]||0;
      const bH  = val>0 ? Math.max(2, Math.round((val/maxVal)*cH)) : 0;
      const x   = gx + 2 + si*(bW+2);
      bars += `<rect x="${x}" y="${padT+cH-bH}" width="${bW}" height="${bH}" fill="${s.color}" rx="2"><title>${s.label}: ${val} (${w.label})</title></rect>`;
    });
    const show = nG<=8 || gi%2===0;
    if (show) xlbls += `<text x="${(gx+gW/2).toFixed(1)}" y="${padT+cH+18}" text-anchor="middle" font-size="9" fill="#94a3b8">${w.label}</text>`;
  });
  const legend = series.map(s=>
    `<div class="legend-item"><div class="legend-dot" style="background:${s.color}"></div>${s.label}</div>`
  ).join("");
  return `<svg viewBox="0 0 ${width} ${height}" width="${width}" height="${height}" style="display:block;max-width:100%;overflow:visible">
    ${grid}${ylbls}${bars}${xlbls}
  </svg><div class="chart-legend">${legend}</div>`;
}

// Fetch org-level weekly PR totals via one GraphQL batch.
async function _fetchOrgWeeklyTrend(days) {
  const weeks = _getWeeks(days);
  const fields = weeks.map((w,i) =>
    `w${i}o: search(query:"type:pr org:senseon-tech created:>=${w.start} created:<=${w.end}", type:ISSUE, first:1){issueCount}` +
    ` w${i}m: search(query:"type:pr is:merged org:senseon-tech merged:>=${w.start} merged:<=${w.end}", type:ISSUE, first:1){issueCount}`
  ).join(" ");
  try {
    const r = await fetch("https://api.github.com/graphql", {
      method:"POST", headers:ghHeaders(), body:JSON.stringify({query:`{${fields}}`}),
    });
    if (!r.ok) return null;
    const json = await r.json();
    if (json.errors) return null;
    const d = json.data;
    return weeks.map((w,i) => ({...w, prs_opened:d[`w${i}o`]?.issueCount??0, prs_merged:d[`w${i}m`]?.issueCount??0}));
  } catch(_) { return null; }
}

// Fetch per-member weekly PR breakdown + total lines contributed (one GraphQL batch).
async function _fetchMemberWeekly(handle, days) {
  const weeks   = _getWeeks(days);
  const since = _isoSince(days);

  const weekFields = weeks.map((w,i) =>
    `w${i}o: search(query:"type:pr author:${handle} org:senseon-tech created:>=${w.start} created:<=${w.end}", type:ISSUE, first:1){issueCount}` +
    ` w${i}m: search(query:"type:pr is:merged author:${handle} org:senseon-tech merged:>=${w.start} merged:<=${w.end}", type:ISSUE, first:1){issueCount}` +
    ` w${i}r: search(query:"type:pr reviewed-by:${handle} org:senseon-tech -author:${handle} updated:>=${w.start} updated:<=${w.end}", type:ISSUE, first:1){issueCount}`
  ).join(" ");

  // Lines via merged PR additions/deletions â€” works for private repos + squash merges
  const prLinesField = `prlines: search(query:"type:pr is:merged author:${handle} org:senseon-tech merged:>=${since}", type:ISSUE, first:100){issueCount nodes{... on PullRequest{additions deletions}}}`;
  const aiBotQuery = `type:pr reviewed-by:${handle} org:senseon-tech author:dependabot OR author:google-labs-jules OR author:copilot-swe-agent updated:>=${since}`;
  const aiReviewField = `airev: search(query:"${aiBotQuery}", type:ISSUE, first:1){issueCount}`;

  try {
    const r = await fetch("https://api.github.com/graphql", {
      method:"POST", headers:ghHeaders(),
      body:JSON.stringify({query:`{${weekFields} ${prLinesField} ${aiReviewField}}`}),
    });
    if (!r.ok) return null;
    const json = await r.json();
    const d = json.data || {};

    const weeklyData = weeks.map((w,i) => ({
      ...w,
      prs_opened:   d[`w${i}o`]?.issueCount ?? 0,
      prs_merged:   d[`w${i}m`]?.issueCount ?? 0,
      prs_reviewed: d[`w${i}r`]?.issueCount ?? 0,
    }));

    const prNodes     = (d.prlines?.nodes || []).filter(Boolean);
    const lines_added   = prNodes.reduce((s,n) => s+(n.additions||0), 0);
    const lines_removed = prNodes.reduce((s,n) => s+(n.deletions||0), 0);
    const merged_prs    = prNodes;
    const ai_prs_reviewed = d.airev?.issueCount ?? 0;

    return {
      weeks: weeklyData,
      lines_added, lines_removed,
      lines_net:     lines_added - lines_removed,
      lines_per_pr:  merged_prs.length > 0 ? Math.round((lines_added+lines_removed)/merged_prs.length) : 0,
      pr_sample:     senseonPRs.length,
      ai_prs_reviewed,
    };
  } catch(_) { return null; }
}

function closeMemberModal() {
  document.getElementById("member-modal-overlay").classList.add("hidden");
  document.body.style.overflow = "";
}

async function openMemberModal(member) {
  const overlay = document.getElementById("member-modal-overlay");
  const body    = document.getElementById("modal-body");
  overlay.classList.remove("hidden");
  document.body.style.overflow = "hidden";

  const s  = member.stats || {};
  const gh = member.github || "";
  const ghStats = STATE.team_cache?.github_stats || {};
  const ant     = STATE.team_cache?.anthropic || null;
  const sc = computeScore({...member, team: member.team}, ghStats, ant);

  const sbox = (val, lbl, col) =>
    `<div class="modal-stat"><div class="modal-stat-v" style="color:${col}">${val!=null?val:"â€”"}</div><div class="modal-stat-l">${lbl}</div></div>`;
  const ghLink = gh
    ? `<a href="https://github.com/${gh}" target="_blank" rel="noopener"
         style="font-size:11px;color:var(--muted);font-family:monospace;text-decoration:none;border:1px solid var(--border);border-radius:20px;padding:2px 10px">@${gh} â†—</a>`
    : "";

  const scorePanel = sc ? `
    <div style="display:flex;align-items:center;gap:14px;background:var(--surface2);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px">
      <div style="text-align:center">
        <div style="font-size:36px;font-weight:900;color:${sc.color};line-height:1">${sc.total}</div>
        <div class="score-badge" style="background:${sc.color}20;color:${sc.color};margin-top:4px;justify-content:center">${sc.tier} Â· ${sc.label}</div>
      </div>
      <div style="flex:1">
        ${[
          {lbl:"Velocity (PRs merged)",  val:sc.c.velocity,  col:"#6366f1"},
          {lbl:"Activity (commits)",     val:sc.c.activity,  col:"#3b82f6"},
          {lbl:"Reviews given",          val:sc.c.review,    col:"#f59e0b"},
          {lbl:"Merge quality",          val:sc.c.quality,   col:"#22c55e"},
          {lbl:"AI adoption",            val:sc.c.ai,        col:"#a855f7"},
        ].map(p=>`<div class="pillar-row">
          <span class="pillar-label">${p.lbl}</span>
          <div class="pillar-bar-bg"><div class="pillar-bar" style="width:${p.val}%;background:${p.col}"></div></div>
          <span class="pillar-val" style="color:${p.col}">${p.val}</span>
        </div>`).join("")}
      </div>
    </div>` : "";

  body.innerHTML = `
    <div class="modal-name">${member.name}${member.lead?' <span style="font-size:13px;font-weight:400;color:var(--muted)"> (Lead)</span>':''}</div>
    <div class="modal-meta">
      <span style="color:var(--accent);font-weight:600">${member.team}</span>
      ${ghLink}
      <span class="cc-tag ${member.enrolled?'cc-yes':'cc-no'}">${member.enrolled?'Claude Code âœ“':'No CC'}</span>
    </div>
    ${scorePanel}
    <div class="modal-stat-grid">
      ${sbox(s?.prs_opened,   "PRs Opened",  "#6366f1")}
      ${sbox(s?.prs_merged,   "Merged",      "#22c55e")}
      ${sbox(s?.prs_reviewed, "Reviewed",    "#f59e0b")}
      ${sbox(s?.commits,      "Commits",     "#e2e8f0")}
    </div>
    <div id="modal-extended" class="modal-loading">${gh ? "Loading extended statsâ€¦" : "No GitHub handle â€” extended stats unavailable"}</div>`;

  if (!gh) return;

  // 1-hour TTL cache for member weekly data
  const mwCache = STATE.team_cache?.member_weekly?.[gh];
  const fresh = mwCache && mwCache.window_days === _teamWindow
    && (Date.now() - new Date(mwCache.fetched_at).getTime()) < 3600000;

  const mw = fresh ? mwCache.data : await _fetchMemberWeekly(gh, _teamWindow);

  if (mw && !fresh && STATE.team_cache) {
    if (!STATE.team_cache.member_weekly) STATE.team_cache.member_weekly = {};
    STATE.team_cache.member_weekly[gh] = {data: mw, fetched_at: new Date().toISOString(), window_days: _teamWindow};
  }

  const extEl = document.getElementById("modal-extended");
  if (!extEl) return;

  if (!mw) {
    extEl.innerHTML = '<p style="color:#ef4444;font-size:12px;text-align:center">Failed to load extended stats.</p>';
    return;
  }

  const mergeRatePct = s.prs_opened > 0 ? Math.round((s.prs_merged||0)/s.prs_opened*100) : null;
  const fmtLines = n => n>=1000?(n/1000).toFixed(1)+"k":n;

  extEl.className = "";
  extEl.innerHTML = `
    <div class="modal-stat-grid" style="margin-bottom:16px">
      ${sbox(mw.lines_added   != null ? "+"+fmtLines(mw.lines_added)   : null, "Lines Added",    "#22c55e")}
      ${sbox(mw.lines_removed != null ? "-"+fmtLines(mw.lines_removed) : null, "Lines Removed",  "#ef4444")}
      ${sbox(mw.lines_per_pr  != null ? mw.lines_per_pr                : null, "Lines / PR",     "#94a3b8")}
      ${sbox(mw.ai_prs_reviewed != null ? mw.ai_prs_reviewed           : null, "AI PRs Reviewed","#a855f7")}
    </div>
    ${mergeRatePct != null ? `<div style="font-size:11px;color:var(--muted);margin-bottom:16px">
      Merge rate: <strong style="color:${mergeRatePct>=75?"#22c55e":mergeRatePct>=50?"#f59e0b":"#ef4444"}">${mergeRatePct}%</strong>
      &nbsp;Â·&nbsp; Lines sample: ${mw.pr_sample} PRs (from contributionsCollection)
    </div>` : ""}
    <div class="chart-title">Weekly Activity â€” ${_teamWindow}d window</div>
    <div class="chart-wrap" style="margin:0">
      ${renderBarChart(mw.weeks, [
        {key:"prs_opened",   label:"Opened",   color:"#6366f1"},
        {key:"prs_merged",   label:"Merged",   color:"#22c55e"},
        {key:"prs_reviewed", label:"Reviewed", color:"#f59e0b"},
      ], 540, 150)}
    </div>`;
}

// â”€â”€ Scoring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Percentile rank: fraction of peers this value beats (0â€“1).
function _pctRank(val, arr) {
  if (arr.length < 2) return 0.5;
  const below = arr.filter(v => v < val).length;
  return below / (arr.length - 1);
}

function computeScore(member, ghStats, ant) {
  if (!member.github || !ghStats) return null;
  const s = ghStats[member.github];
  if (!s) return null;
  const enrolled = member.cc || (ant ? !!ant[member.github] : false);
  const peers = TEAM_DATA.flatMap(t => t.members)
    .filter(m => m.github && ghStats[m.github])
    .map(m => ghStats[m.github]);
  if (peers.length < 2) return null;

  const mergeRate = s.prs_opened > 0 ? s.prs_merged / s.prs_opened : 0;

  const c = {
    velocity:  Math.round(_pctRank(s.prs_merged   || 0, peers.map(p => p.prs_merged   || 0)) * 100),
    activity:  Math.round(_pctRank(s.commits       || 0, peers.map(p => p.commits       || 0)) * 100),
    review:    Math.round(_pctRank(s.prs_reviewed  || 0, peers.map(p => p.prs_reviewed  || 0)) * 100),
    quality:   Math.round(mergeRate * 100),
    ai:        enrolled ? 100 : 0,
    merge_rate: mergeRate,
  };
  const total = Math.min(100, Math.round(
    c.velocity * 0.25 + c.activity * 0.10 + c.review * 0.25 + c.quality * 0.20 + c.ai * 0.20
  ));
  const tier  = total>=90?"S":total>=75?"A":total>=60?"B":total>=45?"C":"D";
  const color = total>=90?"#22c55e":total>=75?"#6366f1":total>=60?"#f59e0b":total>=45?"#f97316":"#ef4444";
  const label = total>=90?"Exceptional":total>=75?"Strong":total>=60?"Solid":total>=45?"Developing":"Needs Support";
  return {total, tier, color, label, c};
}

// Fetch Anthropic org-level usage + cost day-by-day (API only supports single-day queries).
async function _fetchAnthropicOrgUsage(days) {
  if (!_anthropicKey) return null;
  const antHeaders = {"x-api-key":_anthropicKey,"anthropic-version":"2023-06-01"};
  const today = new Date();
  let totalTokens=0, totalCost=0;
  const daily = [];

  for (let i = days-1; i >= 0; i--) {
    const d     = new Date(today.getTime() - i*86400000);
    const dNext = new Date(d.getTime() + 86400000);
    const dStr  = d.toISOString().slice(0,10);
    const dNext2= dNext.toISOString().slice(0,10);

    const [uResp, cResp] = await Promise.all([
      fetch(`${ANT_BASE}/v1/organizations/usage_report/messages?starting_at=${dStr}&ending_at=${dNext2}&bucket_width=1d`,
        {headers: antHeaders}),
      fetch(`${ANT_BASE}/v1/organizations/cost_report?starting_at=${dStr}&ending_at=${dNext2}&bucket_width=1d`,
        {headers: antHeaders}),
    ]);

    let dayTokens=0, dayCost=0;
    if (uResp.ok) {
      const json = await uResp.json();
      for (const b of json.data||[]) for (const r of b.results||[])
        dayTokens += (r.input_tokens||0)+(r.output_tokens||0)
                    +(r.cache_read_input_tokens||0)+(r.cache_creation_input_tokens||0);
    }
    if (cResp.ok) {
      const json = await cResp.json();
      for (const b of json.data||[]) for (const r of b.results||[])
        dayCost += (parseFloat(r.amount)||0)/100;
    }

    totalTokens += dayTokens;
    totalCost   += dayCost;
    if (dayTokens > 0 || dayCost > 0) {
      daily.push({
        label: d.toLocaleString("en-GB",{day:"numeric",month:"short"}),
        tokens: dayTokens,
        cost_usd: Math.round(dayCost*100)/100,
      });
    }
  }

  return (totalTokens>0||totalCost>0)
    ? {tokens: totalTokens, cost_usd: Math.round(totalCost*100)/100, daily}
    : null;
}

function renderLeaderboard(ghStats, ant) {
  const el = document.getElementById("team-leaderboard");
  if (!el) return;
  if (!ghStats) { el.innerHTML = ""; return; }

  const ranked = TEAM_DATA.flatMap(t => t.members.map(m => ({...m, _team: t.team})))
    .filter(m => m.github)
    .map(m => ({m, sc: computeScore({...m, team: m._team}, ghStats, ant)}))
    .filter(x => x.sc)
    .sort((a, b) => b.sc.total - a.sc.total);

  if (!ranked.length) { el.innerHTML = ""; return; }

  const rows = ranked.map(({m, sc}, i) => {
    const medal = i===0?"ðŸ¥‡":i===1?"ðŸ¥ˆ":i===2?"ðŸ¥‰":`${i+1}.`;
    return `<div class="lb-row">
      <span style="width:26px;text-align:center;font-size:13px">${medal}</span>
      <span style="flex:1;font-size:13px;font-weight:600">${m.name}</span>
      <span style="font-size:11px;color:var(--muted);width:72px">${m._team}</span>
      <div class="lb-bar-bg"><div class="lb-bar" style="width:${sc.total}%;background:${sc.color}"></div></div>
      <span style="font-size:14px;font-weight:900;color:${sc.color};width:36px;text-align:right">${sc.total}</span>
      <span class="score-badge" style="background:${sc.color}20;color:${sc.color}">${sc.tier}</span>
    </div>`;
  }).join("");

  el.innerHTML = `<div class="chart-wrap" style="margin-bottom:24px">
    <div class="chart-title">Engineer Performance Scores â€” ${_teamWindow}d window</div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:12px">
      Velocity 25% &middot; Activity 10% &middot; Reviews 25% &middot; Merge quality 20% &middot; AI adoption 20%
    </div>
    ${rows}
  </div>`;
}

// â”€â”€ Build a single GraphQL query batching PR stats for all members.
// Note: COMMIT is not a valid GraphQL SearchType â€” commits fetched separately via REST.
function _buildTeamQuery(days) {
  const since = _isoSince(days);
  const parts = [];
  TEAM_DATA.forEach(({members}) => {
    members.filter(m => m.github).forEach(m => {
      const s = _teamSlug(m.github);
      const g = m.github;
      parts.push(
        `${s}_po: search(query:"type:pr author:${g} org:senseon-tech created:>=${since}", type:ISSUE, first:1){issueCount}`,
        `${s}_pm: search(query:"type:pr is:merged author:${g} org:senseon-tech merged:>=${since}", type:ISSUE, first:1){issueCount}`,
        `${s}_pr: search(query:"type:pr reviewed-by:${g} org:senseon-tech -author:${g} updated:>=${since}", type:ISSUE, first:1){issueCount}`,
      );
    });
  });
  return `{${parts.join(' ')}}`;
}

// Fetch commit counts via REST search API (COMMIT not supported in GraphQL SearchType).
// Runs sequentially with a small delay to stay within the 30 req/min search rate limit.
async function _fetchCommitCounts(days) {
  const since = _isoSince(days);
  const handles = TEAM_DATA.flatMap(t => t.members).filter(m => m.github).map(m => m.github);
  const counts = {};
  for (const handle of handles) {
    const url = `https://api.github.com/search/commits?q=author:${handle}+org:senseon-tech+committer-date:>=${since}&per_page=1`;
    const r = await fetch(url, {headers: ghHeaders()});
    if (r.ok) {
      const json = await r.json();
      counts[handle] = json.total_count ?? 0;
    } else {
      counts[handle] = 0;
    }
    // Small delay to respect 30 req/min search rate limit
    await new Promise(res => setTimeout(res, 400));
  }
  return counts;
}

async function _fetchGitHubTeamStats(days) {
  // Fetch PR stats (GraphQL) and commit counts (REST) in parallel
  const [gqlResult, commitCounts] = await Promise.all([
    (async () => {
      const query = _buildTeamQuery(days);
      const r = await fetch("https://api.github.com/graphql", {
        method: "POST",
        headers: ghHeaders(),
        body: JSON.stringify({query}),
      });
      if (!r.ok) throw new Error(`GitHub GraphQL ${r.status}`);
      const json = await r.json();
      if (json.errors) throw new Error(json.errors[0].message);
      return json.data;
    })(),
    _fetchCommitCounts(days),
  ]);

  const stats = {};
  TEAM_DATA.forEach(({members}) => {
    members.filter(m => m.github).forEach(m => {
      const s = _teamSlug(m.github);
      stats[m.github] = {
        prs_opened:   gqlResult[`${s}_po`]?.issueCount ?? 0,
        prs_merged:   gqlResult[`${s}_pm`]?.issueCount ?? 0,
        prs_reviewed: gqlResult[`${s}_pr`]?.issueCount ?? 0,
        commits:      commitCounts[m.github] ?? 0,
      };
    });
  });
  return stats;
}

// Try Anthropic Admin API for live key enrollment data.
// Very likely CORS-blocked from the browser â€” returns null on failure.
async function _fetchAnthropicEnrollment() {
  if (!_anthropicKey) return null;
  try {
    let items = [], after = null;
    for (let i = 0; i < 10; i++) {
      const url = `${ANT_BASE}/v1/organizations/api_keys?status=active&limit=100${after?'&after_id='+after:''}`;
      const r = await fetch(url, {headers:{"x-api-key":_anthropicKey,"anthropic-version":"2023-06-01"}});
      if (!r.ok) return null;
      const json = await r.json();
      items = items.concat(json.data || []);
      if (!json.has_more) break;
      after = json.last_id;
    }
    // Map claude_code_key_<person>_<suffix> â†’ enrolled handle lookup
    const enrolled = {};
    TEAM_DATA.forEach(({members}) => members.forEach(m => {
      if (!m.github) return;
      // Check if any CC key name contains the member's known claude_key prefix
      const found = items.some(k => k.name?.startsWith("claude_code_key_") &&
        (k.name.includes(m.github.toLowerCase()) || k.name.includes(m.name.toLowerCase().replace(" ","."))));
      if (found) enrolled[m.github] = true;
    }));
    return enrolled;
  } catch(_) {
    return null; // CORS or network
  }
}

async function refreshTeamData() {
  const btn = document.getElementById("btn-team-refresh");
  if (btn) { btn.textContent = "Fetchingâ€¦"; btn.disabled = true; }
  try {
    const [ghResult, antResult, trendResult, antUsageResult] = await Promise.allSettled([
      _fetchGitHubTeamStats(_teamWindow),
      _fetchAnthropicEnrollment(),
      _fetchOrgWeeklyTrend(_teamWindow),
      _fetchAnthropicOrgUsage(_teamWindow),
    ]);
    const ghStats    = ghResult.status       === "fulfilled" ? ghResult.value       : null;
    const ghErr      = ghResult.status       === "rejected"  ? ghResult.reason.message : null;
    const antData    = antResult.status      === "fulfilled" ? antResult.value      : null;
    const orgTrend   = trendResult.status    === "fulfilled" ? trendResult.value    : null;
    const antUsage   = antUsageResult.status === "fulfilled" ? antUsageResult.value : null;
    const prevWeekly = STATE.team_cache?.member_weekly || {};
    STATE.team_cache = {
      window_days:   _teamWindow,
      fetched_at:    new Date().toISOString(),
      github_stats:  ghStats,
      github_error:  ghErr,
      anthropic:     antData,
      ant_usage:     antUsage,
      weekly_org:    orgTrend,
      member_weekly: prevWeekly,
    };
    scheduleSave();
    saveMetricsToFile(STATE.team_cache);
    renderTeam();
    if (ghErr) showSync("Team refresh partial: " + ghErr, true);
    else showSync("Team stats refreshed", false);
  } catch(e) {
    showSync("Team refresh failed: " + e.message, true);
  } finally {
    if (btn) { btn.textContent = "Refresh"; btn.disabled = false; }
  }
}

function renderTeamSummary(stats, antEnrollment) {
  const all = TEAM_DATA.flatMap(t => t.members);
  let po=0, pm=0, pr=0, cm=0, ccYes=0;
  all.forEach(m => {
    const s = m.github && stats ? stats[m.github] : null;
    if (s) { po+=s.prs_opened; pm+=s.prs_merged; pr+=s.prs_reviewed; cm+=s.commits; }
    const enrolled = m.cc || (antEnrollment ? !!antEnrollment[m.github] : false);
    if (enrolled) ccYes++;
  });
  const ccPct = Math.round(ccYes / all.length * 100);
  const ccColor = ccPct>=80?"var(--green)":ccPct>=50?"var(--amber)":"var(--red)";
  document.getElementById("team-summary-banner").innerHTML =
    `<div class="tsb"><div class="tsb-val" style="color:var(--accent)">${po}</div><div class="tsb-lbl">PRs Opened</div></div>
     <div class="tsb"><div class="tsb-val" style="color:var(--green)">${pm}</div><div class="tsb-lbl">Merged</div></div>
     <div class="tsb"><div class="tsb-val" style="color:var(--amber)">${pr}</div><div class="tsb-lbl">Reviewed</div></div>
     <div class="tsb"><div class="tsb-val">${cm}</div><div class="tsb-lbl">Commits</div></div>
     <div class="tsb"><div class="tsb-val" style="color:${ccColor}">${ccPct}%</div><div class="tsb-lbl">Claude Code</div></div>`;
}

function renderTeam() {
  const cache  = STATE.team_cache;
  const staleEl = document.getElementById("team-stale-msg");
  const fatEl   = document.getElementById("team-fetched-at");
  const sects   = document.getElementById("team-sections");

  // Sync window buttons
  document.querySelectorAll(".win-btn[data-days]").forEach(b =>
    b.classList.toggle("active", parseInt(b.dataset.days) === _teamWindow));

  // Stale warning
  const isStale = cache && (Date.now() - new Date(cache.fetched_at).getTime()) > 86400000;
  if (staleEl) staleEl.style.display = isStale ? "block" : "none";

  // Fetched label
  if (fatEl) {
    fatEl.textContent = cache?.fetched_at
      ? `Last fetched ${new Date(cache.fetched_at).toLocaleString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})} Â· ${cache.window_days}d window`
      : "";
  }

  if (!cache) {
    document.getElementById("team-summary-banner").innerHTML = "";
    document.getElementById("team-org-trend").innerHTML = "";
    document.getElementById("team-leaderboard").innerHTML = "";
    document.getElementById("team-ai-usage").innerHTML = "";
    sects.innerHTML = `<div class="team-empty">No data yet â€” click <strong>Refresh</strong> to fetch GitHub stats for the team.</div>`;
    return;
  }

  const ghStats = cache.github_stats || {};
  const ant     = cache.anthropic;   // null = use static .cc field

  renderTeamSummary(ghStats, ant);

  // AI platform usage strip
  const aiUsageEl = document.getElementById("team-ai-usage");
  if (aiUsageEl) {
    const u = cache.ant_usage;
    if (u) {
      const fmt = n => n>=1e9?(n/1e9).toFixed(1)+"B":n>=1e6?(n/1e6).toFixed(1)+"M":n>=1e3?(n/1e3).toFixed(0)+"K":String(n);
      const dailyChart = u.daily?.length
        ? `<div class="chart-wrap" style="margin:12px 0 0"><div class="chart-title">Daily Cost (USD)</div>${renderBarChart(u.daily,[{key:"cost_usd",label:"Cost USD",color:"#a855f7"}],880,100)}</div>`
        : "";
      aiUsageEl.innerHTML = `<div class="chart-wrap" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;margin-bottom:4px">
          <span style="color:var(--accent);font-weight:700;font-size:13px">Anthropic API â€” ${cache.window_days}d</span>
          <span><strong style="color:var(--text);font-size:18px">${fmt(u.tokens)}</strong> <span style="color:var(--muted);font-size:12px">tokens</span></span>
          <span><strong style="color:#a855f7;font-size:18px">$${u.cost_usd.toFixed(2)}</strong> <span style="color:var(--muted);font-size:12px">total cost</span></span>
          <span style="color:var(--muted);font-size:11px;margin-left:auto">Org-level Â· per-person breakdown not available via API</span>
        </div>
        ${dailyChart}
      </div>`;
    } else {
      aiUsageEl.innerHTML = _anthropicKey
        ? `<div class="ai-usage-strip"><span style="color:var(--muted);font-size:11px">Anthropic usage returned no data for this period</span></div>`
        : `<div class="ai-usage-strip"><span style="color:var(--muted);font-size:11px">Add Anthropic Admin key in Settings to show token usage &amp; cost</span></div>`;
    }
  }

  // Leaderboard
  renderLeaderboard(ghStats, ant);

  // Org-level weekly trend chart
  const trendEl = document.getElementById("team-org-trend");
  if (trendEl) {
    const orgTrend = cache.weekly_org;
    if (orgTrend?.length) {
      trendEl.innerHTML = `<div class="chart-wrap"><div class="chart-title">Org Weekly PR Activity</div>${renderBarChart(orgTrend,[{key:"prs_opened",label:"PRs Opened",color:"#6366f1"},{key:"prs_merged",label:"PRs Merged",color:"#22c55e"}],880,160)}</div>`;
    } else {
      trendEl.innerHTML = "";
    }
  }

  const winMismatch = cache.window_days !== _teamWindow;
  let html = winMismatch
    ? `<div class="team-stale">Showing cached ${cache.window_days}-day data. Hit Refresh for ${_teamWindow}-day stats.</div>`
    : "";
  if (cache.github_error)
    html += `<div class="team-stale" style="background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:var(--red)">GitHub error: ${cache.github_error}</div>`;

  TEAM_DATA.forEach(({team, members}) => {
    const cards = members.map(m => {
      const s = m.github && ghStats[m.github] ? ghStats[m.github] : null;
      const enrolled = m.cc || (ant ? !!ant[m.github] : false);
      const statsHtml = s
        ? `<div class="stat-grid4">
            <div class="sbox"><div class="sbox-v" style="color:var(--accent)">${s.prs_opened}</div><div class="sbox-l">Opened</div></div>
            <div class="sbox"><div class="sbox-v" style="color:var(--green)">${s.prs_merged}</div><div class="sbox-l">Merged</div></div>
            <div class="sbox"><div class="sbox-v" style="color:var(--amber)">${s.prs_reviewed}</div><div class="sbox-l">Reviewed</div></div>
            <div class="sbox"><div class="sbox-v">${s.commits}</div><div class="sbox-l">Commits</div></div>
          </div>`
        : `<div style="font-size:11px;color:var(--muted);margin-bottom:10px">${m.github ? "Stats not loaded" : "No GitHub handle"}</div>`;
      const ccHtml = `<span class="cc-tag ${enrolled?"cc-yes":"cc-no"}">${enrolled?"Claude Code âœ“":"No CC"}</span>`;
      const sc = computeScore({...m, team}, ghStats, ant);
      const scoreBadge = sc
        ? `<span class="score-badge" style="background:${sc.color}20;color:${sc.color}">${sc.total} ${sc.tier}</span>` : "";
      const payload = JSON.stringify({name:m.name,github:m.github||"",team,lead:!!m.lead,enrolled,stats:s}).replace(/'/g,"&#39;");
      return `<div class="member-card" onclick='openMemberModal(${payload})'>
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2px">
          <div class="member-name">${m.name}${m.lead?' <span style="font-size:10px;color:var(--muted)">(Lead)</span>':''}</div>
          ${scoreBadge}
        </div>
        <div class="member-handle">${m.github?"@"+m.github:"â€”"}</div>
        ${statsHtml}${ccHtml}
      </div>`;
    }).join("");
    html += `<div class="team-section"><div class="team-section-title">${team}</div><div class="member-grid">${cards}</div></div>`;
  });
  sects.innerHTML = html;
}

function renderSettingsAnthropicKey() {
  const el = document.getElementById("settings-anthropic-key");
  if (el) el.value = _anthropicKey;
  const st = document.getElementById("anthropic-key-status");
  if (st) st.textContent = _anthropicKey ? "Key saved in this browser." : "No key saved.";
}

document.addEventListener("keydown", e => { if (e.key === "Escape") closeMemberModal(); });

// Start
boot();
</script>
</body>
</html>
