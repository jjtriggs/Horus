<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>James Triggs â€” CTO Development</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.github.com; img-src 'self' data: https:; frame-ancestors 'none'">
<style>
:root{--bg:#0a0f1e;--surface:#111827;--surface2:#1a2236;--border:#1f2d44;--text:#e2e8f0;--muted:#94a3b8;--accent:#6366f1;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--radius:8px}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:14px;line-height:1.6;padding-bottom:60px}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:18px 32px;display:flex;align-items:center;justify-content:space-between}
h1{font-size:20px;font-weight:800}
.sub{font-size:12px;color:var(--muted);margin-top:2px}
.header-right{display:flex;align-items:center;gap:12px}
.sync-badge{font-size:11px;padding:3px 10px;border-radius:20px;background:rgba(34,197,94,.15);color:var(--green);opacity:0;transition:opacity .5s}
.sync-badge.show{opacity:1}
.sync-badge.error{background:rgba(239,68,68,.15);color:var(--red);opacity:1}
main{max-width:960px;margin:0 auto;padding:32px 24px}

/* Connect screen */
#connect-screen{max-width:480px;margin:80px auto;text-align:center}
#connect-screen .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:36px}
#connect-screen h2{font-size:20px;font-weight:700;margin-bottom:8px}
#connect-screen p{color:var(--muted);font-size:13px;margin-bottom:24px;line-height:1.6}
.input-wrap{position:relative;margin-bottom:12px}
input[type=password],input[type=text]{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:13px;outline:none;font-family:monospace}
input:focus{border-color:var(--accent)}
.connect-error{color:var(--red);font-size:12px;margin-top:8px;display:none}
.connect-steps{text-align:left;font-size:12px;color:var(--muted);margin-bottom:20px;padding:12px 16px;background:var(--surface2);border-radius:var(--radius);line-height:2}

/* Scores */
.score-banner{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px}
.score-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center}
.score-card.combined{border-color:var(--accent)}
.score-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.score-val{font-size:30px;font-weight:800;margin:5px 0 2px}
.score-max{font-size:11px;color:var(--muted)}
.progress-label{font-size:12px;color:var(--muted);font-weight:600;margin-top:6px}

/* Gates */
.gate-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:28px}
.section-title{font-size:14px;font-weight:700;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.gate-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.gate-label{font-size:12px;width:210px;flex-shrink:0}
.gate-bar-bg{flex:1;background:var(--surface2);border-radius:20px;height:7px;overflow:hidden}
.gate-bar{height:100%;border-radius:20px;transition:width .5s}
.gate-target{font-size:11px;font-weight:700;width:80px;text-align:right;flex-shrink:0}
.gate-controls{margin-top:14px;display:flex;flex-wrap:wrap;gap:14px}
.gate-control{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:12px;color:var(--text)}
.gate-control input[type=number]{width:44px;padding:3px 7px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px;text-align:center}

/* Tabs */
.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:24px}
.tab{padding:10px 20px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted);cursor:pointer;font-size:13px;font-weight:500;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.pane{display:none}.pane.active{display:block}

/* Competencies */
.comp-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.comp-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.comp-title{font-size:15px;font-weight:700}
.comp-id{font-size:11px;color:var(--muted);margin-bottom:2px}
.chip{display:inline-block;padding:3px 12px;border-radius:20px;font-size:12px;font-weight:700}
.chip-g{background:rgba(34,197,94,.15);color:var(--green)}
.chip-a{background:rgba(245,158,11,.15);color:var(--amber)}
.chip-r{background:rgba(239,68,68,.15);color:var(--red)}
.comp-desc{font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.55}
.score-btns{display:flex;gap:7px;margin-bottom:8px}
.sbtn{width:36px;height:36px;border-radius:50%;border:2px solid var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:700;cursor:pointer;transition:all .15s}
.sbtn:hover{border-color:var(--accent);color:var(--text)}
.sbtn.active{border-color:var(--accent);background:var(--accent);color:#fff}
.level-desc{font-size:12px;color:var(--amber);min-height:18px;margin-bottom:10px}
label{font-size:11px;color:var(--muted);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em}
textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;padding:9px 12px;resize:vertical;outline:none;font-family:inherit;line-height:1.5}
textarea:focus{border-color:var(--accent)}

/* Journal */
.journal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px}
.journal-meta{font-size:11px;color:var(--muted);display:flex;justify-content:space-between;margin-bottom:8px}

/* Actions */
.action-group{margin-bottom:20px}
.action-group-title{font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px}
.action-row{display:flex;align-items:flex-start;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px}
.action-row:last-child{border-bottom:none}

/* Buttons */
.btn{padding:8px 16px;border-radius:var(--radius);border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-size:13px;transition:background .15s}
.btn:hover{background:var(--surface2)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:#4f46e5}
.btn-sm{padding:4px 10px;font-size:11px}
.btn-danger{border-color:var(--red);color:var(--red)}
.btn-danger:hover{background:rgba(239,68,68,.1)}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.mt{margin-top:16px}
.info-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;font-size:12px;color:var(--muted);line-height:1.6}
.info-box code{background:var(--bg);padding:2px 6px;border-radius:4px;font-family:monospace;color:var(--text)}
@media(max-width:600px){.score-banner{grid-template-columns:1fr 1fr}.two-col{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Connect screen (shown when not authenticated) -->
<div id="connect-screen" style="display:none">
  <div class="card">
    <div style="font-size:32px;margin-bottom:12px">ðŸ”’</div>
    <h2>CTO Development Tracker</h2>
    <p>Personal development journal for James Triggs.<br/>
    Connect with your GitHub token to load your data from a private Gist.</p>
    <div class="connect-steps">
      <strong style="color:var(--text)">Your data is stored in a private GitHub Gist</strong><br/>
      Only you can read or write it. The token is saved in this browser only.
    </div>
    <input type="password" id="connect-token" placeholder="Paste your GitHub PAT (github_pat_...)" autocomplete="off"/>
    <div id="connect-error" class="connect-error"></div>
    <div class="mt">
      <button class="btn btn-primary" style="width:100%" id="btn-connect">Connect</button>
    </div>
    <p style="margin-top:14px;font-size:11px;color:var(--muted)">
      New device? Enter the same token â€” your Gist will be found automatically.
    </p>
  </div>
</div>

<!-- Main app (shown when authenticated) -->
<div id="app-screen" style="display:none">
<header>
  <div>
    <h1>CTO Development Tracker</h1>
    <div class="sub">James Triggs &middot; Data stored in private GitHub Gist &middot; <span id="last-saved-label">â€”</span></div>
  </div>
  <div class="header-right">
    <span id="sync-badge" class="sync-badge">Saved to Gist</span>
    <button class="btn btn-sm" id="btn-save-now">Save now</button>
    <button class="btn btn-sm btn-danger" id="btn-disconnect">Disconnect</button>
  </div>
</header>

<main>

<div class="score-banner">
  <div class="score-card">
    <div class="score-label">D1 Engineering</div>
    <div class="score-val" id="b-d1">30.0</div>
    <div class="score-max">/ 40</div>
  </div>
  <div class="score-card">
    <div class="score-label">D2 AI Maturity</div>
    <div class="score-val" id="b-d2">13.3</div>
    <div class="score-max">/ 20</div>
  </div>
  <div class="score-card">
    <div class="score-label">D3 Competencies</div>
    <div class="score-val" id="b-d3">â€”</div>
    <div class="score-max">/ 40</div>
  </div>
  <div class="score-card combined">
    <div class="score-label">Combined</div>
    <div class="score-val" id="b-combined">â€”</div>
    <div class="score-max">/ 100</div>
    <div class="progress-label" id="b-label">â€”</div>
  </div>
</div>

<div class="gate-card">
  <div class="section-title">CTO Promotion Gate 1 â€” Individual Readiness</div>
  <div id="gates-container"></div>
  <div class="gate-controls" id="gate-controls"></div>
</div>

<div class="tabs">
  <button class="tab active" data-pane="competencies">Big WHO Scorecard</button>
  <button class="tab" data-pane="journey">Development Journal</button>
  <button class="tab" data-pane="actions">Next Actions</button>
  <button class="tab" data-pane="settings">Settings</button>
</div>

<div class="pane active" id="pane-competencies">
  <div id="competencies-container"></div>
</div>

<div class="pane" id="pane-journey">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <p style="color:var(--muted);font-size:13px">Quarterly reflections. Add an entry after each scorecard session with David.</p>
    <button class="btn btn-primary btn-sm" id="btn-add-journal">+ New Entry</button>
  </div>
  <div id="journal-container"></div>
</div>

<div class="pane" id="pane-actions">
  <div id="actions-container"></div>
</div>

<div class="pane" id="pane-settings">
  <div class="info-box">
    <strong style="color:var(--text)">Your data Gist ID:</strong><br/>
    <code id="settings-gist-id">â€”</code><br/><br/>
    To set up on another device, enter the same GitHub token â€” your Gist will be found automatically by name.
    <br/><br/>
    <strong style="color:var(--text)">D1 and D2 scores</strong> (pulled from the engineering dashboard â€” update when the scorecard changes):<br/>
    <div style="display:flex;gap:12px;margin-top:10px">
      <div>
        <label>D1 weighted score</label>
        <input type="number" id="settings-d1" step="0.1" min="0" max="40" style="width:80px;background:var(--surface);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:5px 8px;font-size:13px"/>
      </div>
      <div>
        <label>D2 weighted score</label>
        <input type="number" id="settings-d2" step="0.1" min="0" max="20" style="width:80px;background:var(--surface);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:5px 8px;font-size:13px"/>
      </div>
    </div>
    <button class="btn btn-sm mt" id="btn-save-d1d2">Update scores</button>
  </div>
</div>

</main>
</div>

<script>
// â”€â”€ Competency definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COMPS = [
  {id:"C1",title:"Supporting Strategic Tech Vision",
   vp:"Internal engineering roadmap, execution focus.",
   cto:"Board-ready tech strategy supporting David's founder vision. You articulate why technical choices create competitive moat and present confidently to investors.",
   levels:["Haven't done this yet","Have an internal roadmap, not board-ready","Can articulate the tech strategy, not yet investor-ready","Contribute meaningfully to board narrative alongside David","Own the technology narrative independently"],
   actions:["Co-present engineering metrics at the July board meeting","Write a one-page technology narrative for Q3 board pack","Shadow David in 2+ customer tech-strategy sessions this quarter"]},
  {id:"C2",title:"Engineering Excellence at Scale",
   vp:"Manage the teams, keep things running day-to-day.",
   cto:"The org operates autonomously. Your week of absence produces zero degradation. Team leads own DORA metrics, incidents resolve without escalation.",
   levels:["Org entirely dependent on me for decisions","Critical decisions still go through me","Some autonomy but I'm still a bottleneck on much","Team leads largely autonomous; I remove blockers","Org runs autonomously; my focus is strategy, not operations"],
   actions:["Publish team lead ownership matrix â€” each lead owns their DORA metrics","Delegate incident command for P1s to leads, review retrospectively","Run a war game: plan a week away and see what would escalate"]},
  {id:"C3",title:"AI-Native Engineering Leadership",
   vp:"Ad hoc AI tool adoption â€” no org-wide standards.",
   cto:"Org-wide AI engineering standards defined and enforced. Eval frameworks in CI, PromptOps is standard practice, AI contribution to velocity measurable.",
   levels:["No AI standards, purely ad hoc","Aware of AI tooling, starting to shape direction","Some standards emerging, actively driving adoption","Standards set, evals in CI, measuring AI contribution to velocity","AI-native culture: AI is default, not exception"],
   actions:["Define and publish PromptOps standards with the pilot team (Q3)","Add LLM eval framework to CI for at least one AI-assisted feature","Produce a monthly AI adoption report for David from dashboard data"]},
  {id:"C4",title:"Cross-Functional Influence",
   vp:"Primarily engineering silo. Other functions come to you with requests.",
   cto:"In revenue conversations, customer tech sessions, and investor narrative discussions. You translate engineering output into business value language fluently.",
   levels:["Engineering silo â€” no external conversations","Starting to engage with other functions reactively","Regular cross-functional input, still reactive","Proactively shaping product/sales/investor narrative","Trusted voice in all business decisions, not just engineering"],
   actions:["Support David in 3 customer tech-strategy meetings this year","Present engineering health dashboard to the full leadership team","Write one external piece (talk, article or podcast) on technical strategy"]},
  {id:"C5",title:"Talent & Culture Builder",
   vp:"Hire engineers when there are open reqs.",
   cto:"Proactively identify world-class talent before you need it. Build a culture that is itself a hiring advantage.",
   levels:["Reactive hiring only, no talent pipeline","Beginning to build relationships with potential hires","Consistent culture investment, some pipeline building","Culture is a differentiator, talent pipeline active","Culture and talent are strategic moats; external recognition"],
   actions:["Identify 3 potential future hires and start a relationship now","Document 'what SenseOn engineering culture means' â€” publish internally","Launch one engineer-facing initiative that builds external reputation"]},
  {id:"C6",title:"Operational Rigor",
   vp:"Reactive â€” firefighting incidents, short-horizon planning.",
   cto:"Board-ready engineering health dashboard (you're building this), proactive capacity planning 2+ quarters out, engineering org is predictable to the business.",
   levels:["Purely reactive, no dashboards or forecasting","Some metrics tracked, still mostly reactive","DORA dashboard live, starting proactive planning","Predictable engineering health, 1-2 quarter horizon","Board-level operational visibility, 2+ quarter forecast horizon"],
   actions:["Present engineering health dashboard as a standing board item (Q3)","Produce Q3 capacity plan and share with David before the quarter","Define SLA for engineering predictability â€” hit it 2 consecutive quarters"]},
];

const GATE_ITEMS = [
  {id:"board",  label:"Board co-presentation delivered", target:"â‰¥1", type:"bool"},
  {id:"customer",label:"Customer tech sessions", target:"â‰¥3", type:"count", threshold:3},
  {id:"dashboard",label:"Eng health dashboard live + weekly review", target:"Live", type:"bool"},
];

// â”€â”€ GitHub Gist storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GIST_FILENAME = "cto_tracker_data.json";
const GIST_DESC     = "CTO Development Tracker â€” private data";
const LS_TOKEN      = "cto_gh_token";
const LS_GIST_ID    = "cto_gist_id";

let _token  = localStorage.getItem(LS_TOKEN)  || "";
let _gistId = localStorage.getItem(LS_GIST_ID) || "";
let _gistSha = "";          // ETag/version â€” not needed for Gist API
let _saveTimer = null;

function ghHeaders() {
  return {"Authorization": `Bearer ${_token}`, "Accept": "application/vnd.github+json", "Content-Type": "application/json"};
}

async function findOrCreateGist() {
  // Search user's gists for one with our description
  let page = 1;
  while (true) {
    const r = await fetch(`https://api.github.com/gists?per_page=100&page=${page}`, {headers: ghHeaders()});
    if (!r.ok) throw new Error(`Gist list failed: ${r.status}`);
    const gists = await r.json();
    if (!gists.length) break;
    const found = gists.find(g => g.description === GIST_DESC);
    if (found) { _gistId = found.id; localStorage.setItem(LS_GIST_ID, _gistId); return _gistId; }
    if (gists.length < 100) break;
    page++;
  }
  // Create new private Gist
  const r2 = await fetch("https://api.github.com/gists", {
    method: "POST", headers: ghHeaders(),
    body: JSON.stringify({description: GIST_DESC, public: false, files: {[GIST_FILENAME]: {content: JSON.stringify(defaultState(), null, 2)}}}),
  });
  if (!r2.ok) throw new Error(`Gist create failed: ${r2.status}`);
  const gist = await r2.json();
  _gistId = gist.id; localStorage.setItem(LS_GIST_ID, _gistId);
  return _gistId;
}

async function loadFromGist() {
  if (!_gistId) await findOrCreateGist();
  const r = await fetch(`https://api.github.com/gists/${_gistId}`, {headers: ghHeaders()});
  if (!r.ok) throw new Error(`Gist read failed: ${r.status}`);
  const gist = await r.json();
  const raw  = gist.files[GIST_FILENAME]?.content;
  return raw ? JSON.parse(raw) : defaultState();
}

async function saveToGist(state) {
  if (!_gistId) return;
  const r = await fetch(`https://api.github.com/gists/${_gistId}`, {
    method: "PATCH", headers: ghHeaders(),
    body: JSON.stringify({files: {[GIST_FILENAME]: {content: JSON.stringify(state, null, 2)}}}),
  });
  if (!r.ok) throw new Error(`Gist write failed: ${r.status}`);
  return r.json();
}

function scheduleSave() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async () => {
    try {
      await saveToGist(STATE);
      showSync("Saved to Gist", false);
      STATE.last_saved = new Date().toISOString();
      document.getElementById("last-saved-label").textContent = `Saved ${new Date().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}`;
    } catch(e) {
      showSync("Save failed: " + e.message, true);
    }
  }, 2000);
}

function showSync(msg, isError) {
  const el = document.getElementById("sync-badge");
  el.textContent = msg;
  el.className = "sync-badge show" + (isError ? " error" : "");
  if (!isError) setTimeout(() => el.classList.remove("show"), 3000);
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function defaultState() {
  return {scores:{C1:3,C2:3,C3:3,C4:3,C5:3,C6:3}, evidence:{}, journal:[], actions:{}, gates:{}, d1:30.0, d2:13.3, last_saved:null};
}
let STATE = defaultState();

function compute() {
  const raw  = Object.values(STATE.scores).reduce((a,b)=>a+b,0);
  const d3   = +(raw/30*40).toFixed(1);
  const comb = +(STATE.d1 + STATE.d2 + d3).toFixed(1);
  const lbl  = comb>=84?"CTO-Ready":comb>=78?"Strong":comb>=62?"Progressing":comb>=50?"Developing":"Early";
  const minS = Math.min(...Object.values(STATE.scores));
  return {raw, d3, comb, lbl, minS};
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBanner() {
  const s = compute();
  document.getElementById("b-d1").textContent = STATE.d1.toFixed(1);
  document.getElementById("b-d2").textContent = STATE.d2.toFixed(1);
  document.getElementById("b-d3").textContent = s.d3.toFixed(1);
  document.getElementById("b-combined").textContent = s.comb.toFixed(1);
  document.getElementById("b-label").textContent = s.lbl;
}

function renderGates() {
  const s = compute();
  const passes = [
    s.raw >= 22,
    s.minS >= 3,
    !!STATE.gates.board,
    (parseInt(STATE.gates.customer)||0) >= 3,
    !!STATE.gates.dashboard,
  ];
  const labels  = ["D3 score â‰¥22/30", "No competency below 3", "Board co-presentation", "Customer tech sessions", "Eng health dashboard"];
  const targets = ["â‰¥22/30", "All â‰¥3", "â‰¥1 done", "â‰¥3", "Live"];
  const pcts    = [
    Math.min(100, Math.round(s.raw/22*100)),
    s.minS >= 3 ? 100 : Math.round(s.minS/3*100),
    passes[2]?100:0, Math.min(100,Math.round(((parseInt(STATE.gates.customer)||0)/3)*100)), passes[4]?100:0,
  ];
  document.getElementById("gates-container").innerHTML = labels.map((lbl,i) => {
    const col = passes[i]?"var(--green)":pcts[i]>50?"var(--amber)":"var(--red)";
    return `<div class="gate-row">
      <span class="gate-label">${lbl}</span>
      <div class="gate-bar-bg"><div class="gate-bar" style="width:${pcts[i]}%;background:${col}"></div></div>
      <span class="gate-target" style="color:${col}">${targets[i]}</span>
    </div>`;
  }).join("");
  document.getElementById("gate-controls").innerHTML = `
    <label class="gate-control"><input type="checkbox" ${STATE.gates.board?"checked":""} id="g-board"/> Board co-presentation delivered</label>
    <label class="gate-control"><input type="checkbox" ${STATE.gates.dashboard?"checked":""} id="g-dashboard"/> Eng health dashboard live + reviewed weekly</label>
    <label class="gate-control">Customer tech sessions: <input type="number" id="g-customer" min="0" max="20" value="${STATE.gates.customer||0}"/> / 3</label>`;
  document.getElementById("g-board").onchange    = e => { STATE.gates.board = e.target.checked; scheduleSave(); renderGates(); };
  document.getElementById("g-dashboard").onchange = e => { STATE.gates.dashboard = e.target.checked; scheduleSave(); renderGates(); };
  document.getElementById("g-customer").onchange  = e => { STATE.gates.customer = parseInt(e.target.value)||0; scheduleSave(); renderGates(); };
}

function renderCompetencies() {
  document.getElementById("competencies-container").innerHTML = COMPS.map(c => {
    const sc  = STATE.scores[c.id]||0;
    const ev  = STATE.evidence[c.id]||"";
    const ch  = sc>=4?"chip-g":sc>=3?"chip-a":"chip-r";
    const btns= [1,2,3,4,5].map(n=>`<button class="sbtn${sc===n?" active":""}" data-comp="${c.id}" data-n="${n}">${n}</button>`).join("");
    return `<div class="comp-card" id="cc-${c.id}">
      <div class="comp-hdr">
        <div><div class="comp-id">${c.id}</div><div class="comp-title">${c.title}</div></div>
        <span class="chip ${ch}" id="ch-${c.id}">${sc||"â€”"}/5</span>
      </div>
      <div class="comp-desc"><strong style="color:var(--text)">VP Eng now:</strong> ${c.vp}<br/><strong style="color:var(--text)">CTO target:</strong> ${c.cto}</div>
      <div class="score-btns">${btns}</div>
      <div class="level-desc" id="ld-${c.id}">${sc?c.levels[sc-1]:""}</div>
      <label>Evidence &amp; examples â€” what demonstrates this score?</label>
      <textarea rows="3" data-ev="${c.id}" placeholder="Concrete examples from the last 90 days...">${ev}</textarea>
    </div>`;
  }).join("");
}

function renderJournal() {
  const c = document.getElementById("journal-container");
  if (!STATE.journal.length) { c.innerHTML = `<p style="color:var(--muted);text-align:center;padding:32px">No entries yet. Click New Entry after each scorecard session.</p>`; return; }
  c.innerHTML = STATE.journal.slice().reverse().map((e,ri) => {
    const idx = STATE.journal.length-1-ri;
    return `<div class="journal-card">
      <div class="journal-meta">
        <span>${e.date} &middot; D3: ${e.d3raw}/30 &middot; Combined: ${e.combined}/100</span>
        <button class="btn btn-sm btn-danger" data-del="${idx}">Delete</button>
      </div>
      <textarea rows="6" data-jidx="${idx}" placeholder="Reflection: what went well, what to improve, what David said...">${e.text||""}</textarea>
    </div>`;
  }).join("");
}

function renderActions() {
  document.getElementById("actions-container").innerHTML = COMPS.map(c => {
    const done = STATE.actions[c.id]||[];
    return `<div class="action-group">
      <div class="action-group-title">${c.id}: ${c.title}</div>
      ${c.actions.map((a,i)=>{
        const key=`${c.id}_${i}`;const chk=done.includes(key);
        return `<div class="action-row">
          <input type="checkbox" ${chk?"checked":""} data-act="${key}" data-cid="${c.id}"/>
          <span style="text-decoration:${chk?"line-through":"none"};color:${chk?"var(--muted)":"var(--text)"}">${a}</span>
        </div>`;
      }).join("")}
    </div>`;
  }).join("");
}

function renderSettings() {
  document.getElementById("settings-gist-id").textContent = _gistId || "Not connected";
  const d1 = document.getElementById("settings-d1");
  const d2 = document.getElementById("settings-d2");
  if (d1) d1.value = STATE.d1;
  if (d2) d2.value = STATE.d2;
}

function renderAll() { renderBanner(); renderGates(); renderCompetencies(); renderJournal(); renderActions(); renderSettings(); }

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("click", e => {
  // Score buttons
  const sbtn = e.target.closest(".sbtn[data-comp]");
  if (sbtn) {
    const cid = sbtn.dataset.comp, n = parseInt(sbtn.dataset.n), c = COMPS.find(x=>x.id===cid);
    STATE.scores[cid] = n;
    // Update card inline
    document.querySelectorAll(`.sbtn[data-comp="${cid}"]`).forEach(b => b.classList.toggle("active", parseInt(b.dataset.n)===n));
    document.getElementById(`ld-${cid}`).textContent = c.levels[n-1];
    const ch = n>=4?"chip-g":n>=3?"chip-a":"chip-r";
    document.getElementById(`ch-${cid}`).className = `chip ${ch}`;
    document.getElementById(`ch-${cid}`).textContent = `${n}/5`;
    renderBanner(); renderGates();
    scheduleSave(); return;
  }
  // Delete journal
  const del = e.target.closest("[data-del]");
  if (del && confirm("Delete this entry?")) {
    STATE.journal.splice(parseInt(del.dataset.del),1);
    renderJournal(); scheduleSave(); return;
  }
  // Action checkbox
  const act = e.target.closest("[data-act]");
  if (act && act.tagName==="INPUT") {
    const key=act.dataset.act, cid=act.dataset.cid;
    if (!STATE.actions[cid]) STATE.actions[cid]=[];
    if (act.checked) { if(!STATE.actions[cid].includes(key)) STATE.actions[cid].push(key); }
    else STATE.actions[cid]=STATE.actions[cid].filter(k=>k!==key);
    renderActions(); scheduleSave(); return;
  }
});

document.addEventListener("change", e => {
  // Evidence textarea
  const ev = e.target.dataset.ev;
  if (ev) { STATE.evidence[ev] = e.target.value; scheduleSave(); return; }
  // Journal textarea
  const ji = e.target.dataset.jidx;
  if (ji !== undefined) { STATE.journal[parseInt(ji)].text = e.target.value; scheduleSave(); return; }
});

// â”€â”€ Boot & auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  if (_token) {
    try {
      // Verify token still valid
      const r = await fetch("https://api.github.com/user", {headers: ghHeaders()});
      if (!r.ok) throw new Error("Token invalid");
      const user = await r.json();
      if (user.login !== "jjtriggs") throw new Error(`Wrong account: ${user.login}`);
      // Load data
      STATE = await loadFromGist();
      showApp();
    } catch(e) {
      localStorage.removeItem(LS_TOKEN);
      localStorage.removeItem(LS_GIST_ID);
      _token=""; _gistId="";
      showConnect(e.message);
    }
  } else {
    showConnect();
  }
}

function showConnect(err) {
  document.getElementById("connect-screen").style.display="block";
  document.getElementById("app-screen").style.display="none";
  if (err) { document.getElementById("connect-error").textContent=err; document.getElementById("connect-error").style.display="block"; }
}

function showApp() {
  document.getElementById("connect-screen").style.display="none";
  document.getElementById("app-screen").style.display="block";
  renderAll();
  if (STATE.last_saved) {
    document.getElementById("last-saved-label").textContent = `Last saved ${new Date(STATE.last_saved).toLocaleString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})}`;
  }
}

document.getElementById("btn-connect").addEventListener("click", async () => {
  const token = document.getElementById("connect-token").value.trim();
  const errEl = document.getElementById("connect-error");
  const btn   = document.getElementById("btn-connect");
  if (!token) { errEl.textContent="Please paste your GitHub token."; errEl.style.display="block"; return; }
  btn.textContent="Connectingâ€¦"; btn.disabled=true;
  try {
    const r = await fetch("https://api.github.com/user", {headers: {"Authorization":`Bearer ${token}`,"Accept":"application/vnd.github+json"}});
    if (!r.ok) throw new Error(`GitHub API ${r.status} â€” check your token`);
    const user = await r.json();
    if (user.login !== "jjtriggs") throw new Error(`This token belongs to '${user.login}', not jjtriggs`);
    _token = token;
    localStorage.setItem(LS_TOKEN, token);
    STATE = await loadFromGist();
    showApp();
  } catch(e) {
    errEl.textContent = e.message; errEl.style.display="block";
  } finally { btn.textContent="Connect"; btn.disabled=false; }
});

document.getElementById("btn-disconnect").addEventListener("click", () => {
  if (!confirm("This clears your saved token from this browser. Your Gist data is unaffected.")) return;
  localStorage.removeItem(LS_TOKEN); localStorage.removeItem(LS_GIST_ID);
  _token=""; _gistId="";
  showConnect();
});

document.getElementById("btn-save-now").addEventListener("click", async () => {
  try { await saveToGist(STATE); showSync("Saved to Gist", false); }
  catch(e) { showSync("Save failed: "+e.message, true); }
});

document.getElementById("btn-add-journal").addEventListener("click", () => {
  const s = compute();
  STATE.journal.push({date: new Date().toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}), d3raw:s.raw, combined:s.comb, text:""});
  renderJournal(); scheduleSave();
  document.querySelector("[data-jidx='0']")?.focus();
});

document.querySelectorAll(".tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".pane").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(`pane-${btn.dataset.pane}`).classList.add("active");
    if (btn.dataset.pane==="settings") renderSettings();
  });
});

document.getElementById("btn-save-d1d2")?.addEventListener("click", () => {
  STATE.d1 = parseFloat(document.getElementById("settings-d1").value) || 30.0;
  STATE.d2 = parseFloat(document.getElementById("settings-d2").value) || 13.3;
  renderBanner(); scheduleSave();
});

// Start
boot();
</script>
</body>
</html>
